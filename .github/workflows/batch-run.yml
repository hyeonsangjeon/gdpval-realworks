name: Run GDPVal Batch Experiment

# This workflow can only be triggered manually from the GitHub Actions tab.
# Only users with repo write access can run it â†’ security enforced automatically.
on:
  workflow_dispatch:
    inputs:
      experiment_yaml:
        description: 'Experiment YAML filename (without .yaml extension, e.g., "exp998_smoke_baseline_sample")'
        required: true
        type: string
      experiment_name:
        description: 'Experiment name (optional - will auto-extract from YAML if empty)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (skip HF upload and PR creation)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write        # to commit yaml results
  pull-requests: write   # to create PRs

env:
  PYTHON_VERSION: '3.11'

jobs:
  batch-run:
    runs-on: ubuntu-latest
    timeout-minutes: 360    # max 6 hours

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install -r batch-runner/requirements.txt

      # â”€â”€ Verify runtime environment â”€â”€
      - name: Verify runtime environment
        run: |
          echo "============================================"
          echo "ğŸ” Runtime Environment Check"
          echo "============================================"
          echo "ğŸ Python: $(python3 --version)"
          echo "ğŸ“¦ pip: $(pip --version)"
          echo "ğŸ¬ ffmpeg: $(ffmpeg -version 2>&1 | head -1)"
          echo "ğŸ“„ LibreOffice: $(libreoffice --version 2>/dev/null || echo 'not installed (expected for baseline)')"
          echo "ğŸ”¤ Noto Sans: $(fc-list 2>/dev/null | grep -c 'Noto Sans') fonts found"
          echo "ğŸ’¾ Disk: $(df -h / | tail -1 | awk '{print $4}') available"
          echo "ğŸ§  Memory: $(free -h | grep Mem | awk '{print $7}') available"
          echo "============================================"

      # â”€â”€ Validation: Check YAML file exists â”€â”€
      - name: Validate experiment YAML exists
        run: |
          YAML_FILE="batch-runner/experiments/${{ inputs.experiment_yaml }}.yaml"
          if [ ! -f "$YAML_FILE" ]; then
            echo "âŒ Error: $YAML_FILE not found"
            exit 1
          fi
          echo "âœ… Found: $YAML_FILE"

      # â”€â”€ Extract experiment_name from YAML if not provided â”€â”€
      - name: Extract experiment name from YAML
        run: |
          YAML_PATH="batch-runner/experiments/${{ inputs.experiment_yaml }}.yaml"
          if [ -z "${{ inputs.experiment_name }}" ]; then
            EXPERIMENT_NAME=$(python3 -c "import yaml,sys; cfg=yaml.safe_load(open(sys.argv[1])); n=cfg.get('experiment',{}).get('name',''); (print(n) if n else sys.exit('ERROR: experiment.name not found'))" "$YAML_PATH")
          else
            EXPERIMENT_NAME="${{ inputs.experiment_name }}"
          fi
          echo "experiment_name=$EXPERIMENT_NAME" >> $GITHUB_ENV
          echo "ğŸ“ Experiment: $EXPERIMENT_NAME"

      # â”€â”€ Conditional: LibreOffice + Noto Sans fonts â”€â”€
      - name: Read experiment config flags
        id: read_config
        run: |
          YAML_FILE="batch-runner/experiments/${{ inputs.experiment_yaml }}.yaml"
          INSTALL_LO=$(python3 -c "
          import yaml
          with open('$YAML_FILE') as f:
              cfg = yaml.safe_load(f)
          print(cfg.get('execution', {}).get('install_libreoffice', False))
          ")
          echo "install_libreoffice=$INSTALL_LO" >> $GITHUB_OUTPUT

      - name: Install LibreOffice & Noto Sans fonts
        if: steps.read_config.outputs.install_libreoffice == 'True'
        run: |
          echo "ğŸ“¦ Installing LibreOffice (headless) + Noto Sans fonts..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libreoffice-core \
            libreoffice-calc \
            libreoffice-impress \
            libreoffice-writer \
            fonts-noto-core \
            fonts-noto-cjk
          fc-cache -fv
          echo "âœ… LibreOffice version:"
          libreoffice --version
          echo "âœ… Noto Sans available:"
          fc-list | grep -i "Noto Sans" | head -5
          echo "âœ… ffmpeg (pre-installed):"
          ffmpeg -version 2>&1 | head -1

      # â”€â”€ Step 0: Bootstrap â”€â”€
      - name: 'Step 0: Bootstrap submission repo'
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cd batch-runner
          bash step0_bootstrap.sh experiments/${{ inputs.experiment_yaml }}.yaml

      # â”€â”€ Step 1: Prepare Tasks â”€â”€
      - name: 'Step 1: Prepare tasks'
        run: |
          cd batch-runner
          bash step1_prepare_tasks.sh experiments/${{ inputs.experiment_yaml }}.yaml

      # â”€â”€ Step 2a: Run Inference (condition_a) â”€â”€
      - name: 'Step 2a: Run inference (condition_a)'
        timeout-minutes: 330    # â† sufficient time for full run, adjust if needed  condition_a
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd batch-runner
          bash step2_run_inference.sh condition_a

      # â”€â”€ Step 2b: Run Inference (condition_b) â€” CONDITIONAL â”€â”€
      - name: 'Check if condition_b exists'
        id: check_condition_b
        run: |
          YAML_PATH="batch-runner/experiments/${{ inputs.experiment_yaml }}.yaml"
          HAS_CONDITION_B=$(python3 -c "import yaml; cfg=yaml.safe_load(open('${YAML_PATH}')); print('true' if 'condition_b' in cfg else 'false')")
          echo "has_condition_b=$HAS_CONDITION_B" >> $GITHUB_OUTPUT
          echo "Condition B exists: $HAS_CONDITION_B"

      - name: 'Step 2b: Run inference (condition_b)'
        timeout-minutes: 330
        if: steps.check_condition_b.outputs.has_condition_b == 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd batch-runner
          bash step2_run_inference.sh condition_b

      # â”€â”€ Step 3: Format Results â”€â”€
      - name: 'Step 3: Format results'
        run: |
          cd batch-runner
          bash step3_format_results.sh

      # â”€â”€ Step 4: Fill Parquet â”€â”€
      - name: 'Step 4: Fill parquet'
        run: |
          cd batch-runner
          bash step4_fill_parquet.sh

      # â”€â”€ Check sample_size (skip validation for smoke tests) â”€â”€
      - name: 'Check if smoke test'
        id: check_smoke_test
        run: |
          YAML_PATH="batch-runner/experiments/${{ inputs.experiment_yaml }}.yaml"
          SAMPLE_SIZE=$(python3 -c "import yaml; cfg=yaml.safe_load(open('${YAML_PATH}')); s=cfg.get('data',{}).get('filter',{}).get('sample_size',220); print(s if s is not None else 220)")
          IS_SMOKE_TEST=$([ "$SAMPLE_SIZE" -le 3 ] && echo "true" || echo "false")
          echo "sample_size=$SAMPLE_SIZE" >> $GITHUB_OUTPUT
          echo "is_smoke_test=$IS_SMOKE_TEST" >> $GITHUB_OUTPUT
          echo "Sample size: $SAMPLE_SIZE (smoke test: $IS_SMOKE_TEST)"

      # â”€â”€ Step 5: Validate (skip for smoke tests or dry_run) â”€â”€
      - name: 'Step 5: Validate dataset'
        if: inputs.dry_run != true && steps.check_smoke_test.outputs.is_smoke_test != 'true'
        run: |
          cd batch-runner
          bash step5_validate.sh

      # â”€â”€ Step 6: Generate Experiment Report â”€â”€
      - name: 'Step 6: Generate experiment report'
        if: always()
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
        run: |
          cd batch-runner
          bash step6_report.sh
        continue-on-error: true   # report failure must not block Step 7 upload

      # â”€â”€ Step 7: Upload to HuggingFace (only if not dry_run) â”€â”€
      - name: 'Step 7: Upload to HuggingFace'
        if: inputs.dry_run != true
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          cd batch-runner
          bash step7_upload_hf.sh --test

      # â”€â”€ Create Pull Request (only if not dry_run) â”€â”€
      - name: Create Pull Request with results
        if: inputs.dry_run != true
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "experiment: ${{ env.experiment_name }}"
          title: "ğŸ§ª New Experiment: ${{ env.experiment_name }}"
          body: |
            ## Experiment Results

            | Field | Value |
            |---|---|
            | **Name** | ${{ env.experiment_name }} |
            | **YAML Config** | `${{ inputs.experiment_yaml }}` |
            | **Run ID** | [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

            ### Pipeline Summary
            - âœ… Step 0: Bootstrap submission repo
            - âœ… Step 1: Prepare tasks
            - âœ… Step 2: Run inference (condition_a)
            - âœ… Step 2: Run inference (condition_b) â€” ${{ steps.check_condition_b.outputs.has_condition_b == 'true' && 'Run' || 'Skipped' }}
            - âœ… Step 3: Format results
            - âœ… Step 4: Fill parquet
            - âœ… Step 5: Validate dataset â€” ${{ steps.check_smoke_test.outputs.is_smoke_test == 'true' && 'Skipped (smoke test)' || 'Run' }}
            - âœ… Step 6: Generate experiment report
            - âœ… Step 7: Upload to HuggingFace

            Results uploaded to HuggingFace dataset repository.
            Review and merge to finalize the experiment.
          branch: experiment/${{ inputs.experiment_yaml }}
          labels: experiment,automated

      # â”€â”€ Summary step â”€â”€
      - name: Show summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Batch Experiment Complete"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Experiment: ${{ env.experiment_name }}"
          echo "YAML Config: ${{ inputs.experiment_yaml }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo ""
          echo "Check artifacts for full pipeline output."

      # â”€â”€ Upload artifacts â”€â”€
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: batch-results-${{ github.run_id }}
          path: |
            batch-runner/workspace/
            batch-runner/results/
          retention-days: 30
